"0","library(dplyr)"
"0",""
"0","variance_partition <- function(var) {"
"0","  df <- combined_df %>%"
"0","    mutate(Group = interaction(Species, test, expTreatment, sep = ""-"")) %>%"
"0","    select(Group, all_of(var)) %>%"
"0","    rename(Response = all_of(var)) %>%"
"0","    filter(!is.na(Response))"
"0","  "
"0","  grand_mean <- mean(df$Response, na.rm = TRUE)"
"0","  "
"0","  group_stats <- df %>%"
"0","    group_by(Group) %>%"
"0","    summarise("
"0","      n = sum(!is.na(Response)),"
"0","      group_mean = mean(Response, na.rm = TRUE),"
"0","      group_var = ifelse(n > 1, var(Response, na.rm = TRUE), 0) # var=0 if only 1 obs"
"0","    )"
"0","  "
"0","  # Between group variance"
"0","  between_var <- sum(group_stats$n * (group_stats$group_mean - grand_mean)^2) / (sum(group_stats$n) - 1)"
"0","  "
"0","  # Within group variance"
"0","  within_var <- sum((group_stats$n - 1) * group_stats$group_var) / (sum(group_stats$n) - nrow(group_stats))"
"0","  "
"0","  total_var <- var(df$Response, na.rm = TRUE)"
"0","  "
"0","  data.frame("
"0","    Response = var,"
"0","    Between_Group_Var = between_var,"
"0","    Within_Group_Var = within_var,"
"0","    Total_Var = total_var,"
"0","    Prop_Between = between_var / total_var,"
"0","    Prop_Within = within_var / total_var"
"0","  )"
"0","}"
"0","# Apply to all response variables"
"0","variance_summary <- bind_rows(lapply(vars_to_test, variance_partition))"
"0",""
"0","print(variance_summary)"
