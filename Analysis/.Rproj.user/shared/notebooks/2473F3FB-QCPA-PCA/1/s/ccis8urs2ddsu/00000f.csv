"0","cols_to_keep <- c(""TrialName"", ""Species"", ""Individual"", "
"0","                  ""CAA:Asp"", ""VCA:CVL"", ""Lum mean"", ""PC1"")"
"0",""
"0","combined_df <- map2_dfr(merged_dfs, names(merged_dfs), ~ {"
"0","  df <- .x"
"0","  test_name <- .y"
"0","  "
"0","  # Calculate PC1 first â€” this will add or overwrite the PC1 column"
"0","  df <- calc_PC1(df, ""Figures/ColourPatterns/PCA/PC1_formula.rds"", pc1_colname = ""PC1"")"
"0","  "
"0","  if (str_starts(test_name, ""bg_"") | str_starts(test_name, ""both_"")) {"
"0","    med_cols <- paste0(""med_"", cols_to_keep[-(1:3)])"
"0","    med_cols_present <- intersect(med_cols, colnames(df))"
"0","    cols_to_select <- c(""TrialName"", ""Species"", ""Individual"", med_cols_present, ""PC1"")"
"0","    # Add PC1 explicitly since it may not be med_ prefixed"
"0","    df_sel <- df %>% select(all_of(cols_to_select))"
"0","    "
"0","    rename_map <- setNames("
"0","      nm = str_remove(med_cols_present, ""^med_""),"
"0","      object = med_cols_present"
"0","    )"
"0","    df_sel <- df_sel %>% rename(!!!rename_map)"
"0","  } else {"
"0","    cols_present <- intersect(cols_to_keep, colnames(df))"
"0","    df_sel <- df %>% select(all_of(cols_present))"
"0","  }"
"0","  "
"0","  df_sel %>%"
"0","    mutate("
"0","      expTreatment = case_when("
"0","        str_detect(TrialName, ""_C_"") ~ ""control"","
"0","        str_detect(TrialName, ""_P_"") ~ ""predator"","
"0","        TRUE ~ NA_character_"
"0","      ),"
"0","      Species = factor(Species, levels = c(""Botia_lohachata"", ""Yasuhikotakia_modesta"")),"
"0","      expTreatment = factor(expTreatment, levels = c(""control"", ""predator"")),"
"0","      test = test_name"
"0","    ) %>%"
"0","    select("
"0","      TrialName,"
"0","      Species,"
"0","      Individual,"
"0","      test,"
"0","      expTreatment,"
"0","      everything()"
"0","    )"
"0","})"
"0",""
"0","print(combined_df)"
